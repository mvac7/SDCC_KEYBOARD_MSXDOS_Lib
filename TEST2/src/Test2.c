/* =============================================================================
   Test2 GetKeyMatrix() 
   Test SDCC Keyboard MSXROM Lib v1.0
   Version: 1.0
   Date: 14/07/2018
   Author: mvac7/303bcn
   Architecture: MSX
   Format:  .COM (MSX-DOS)
   Programming language: C (SDCC)
   WEB: 
   mail: mvac7303b@gmail.com

   Description:
     Test the GetKeyMatrix function of the MSXDOS Keyboard library.
     
   History of versions:
     - v1.0 (14/07/2018)
     
============================================================================= */

#include "../include/newTypes.h"
#include "../include/msxSystemVars.h"
#include "../include/msxBIOS.h"
#include "../include/msxDOS.h"

#include "../include/memory.h"
#include "../include/keyboard.h"
#include "../include/VDP_TMS9918A.h"



#define  HALT __asm halt __endasm   //Z80 instruction > wait for the next interrupt

#define  SYSTEM 0x0005  // MSX-DOS entry



// Function Declarations -------------------------------------------------------
void System(char code);

void test();

void printKey(char column, char line);

void PRINT(char column, char line, char* text);
uint GetVAddressByPosition(char column, char line);
void CLS();
char PEEK(uint address);


// constants  ------------------------------------------------------------------
const char text01[] = "Test GetKeyMatrix() v1.0 (14/07/2018)";
const char text02[] = "Test SDCC Keyboard MSXDOS Lib v1.0";
const char text03[] = "Hold down ESC key for exit to DOS";



// TEST Apps
// map size width:40 height:24
// Size= 960
const unsigned char keyb_map[]={
0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,
0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,
0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,
0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,
0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,
0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,
0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,
0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,
0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,
0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,
0x20,0x20,0x20,0x20,0x20,0x37,0x20,0x20,0x20,0x36,0x20,0x20,0x20,0x35,0x20,0x20,
0x20,0x34,0x20,0x20,0x20,0x33,0x20,0x20,0x20,0x32,0x20,0x20,0x20,0x31,0x20,0x20,
0x20,0x30,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x18,0x17,0x17,0x17,0x12,
0x17,0x17,0x17,0x12,0x17,0x17,0x17,0x12,0x17,0x17,0x17,0x12,0x17,0x17,0x17,0x12,
0x17,0x17,0x17,0x12,0x17,0x17,0x17,0x12,0x17,0x17,0x17,0x19,0x20,0x20,0x20,0x20,
0x20,0x20,0x30,0x16,0x20,0x37,0x20,0x16,0x20,0x36,0x20,0x16,0x20,0x35,0x20,0x16,
0x20,0x34,0x20,0x16,0x20,0x33,0x20,0x16,0x20,0x32,0x20,0x16,0x20,0x31,0x20,0x16,
0x20,0x30,0x20,0x16,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x14,0x17,0x17,0x17,0x15,
0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,
0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x13,0x20,0x20,0x20,0x20,
0x20,0x20,0x31,0x16,0x20,0x3B,0x20,0x16,0x20,0x5D,0x20,0x16,0x20,0x5B,0x20,0x16,
0x20,0x5C,0x20,0x16,0x20,0x3D,0x20,0x16,0x20,0x2D,0x20,0x16,0x20,0x39,0x20,0x16,
0x20,0x38,0x20,0x16,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x14,0x17,0x17,0x17,0x15,
0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,
0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x13,0x20,0x20,0x20,0x20,
0x20,0x20,0x32,0x16,0x20,0x42,0x20,0x16,0x20,0x41,0x20,0x16,0x41,0x63,0x4F,0x16,
0x20,0x2F,0x20,0x16,0x20,0x2E,0x20,0x16,0x20,0x2C,0x20,0x16,0x41,0x63,0x43,0x16,
0x20,0x27,0x20,0x16,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x14,0x17,0x17,0x17,0x15,
0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,
0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x13,0x20,0x20,0x20,0x20,
0x20,0x20,0x33,0x16,0x20,0x4A,0x20,0x16,0x20,0x49,0x20,0x16,0x20,0x48,0x20,0x16,
0x20,0x47,0x20,0x16,0x20,0x46,0x20,0x16,0x20,0x45,0x20,0x16,0x20,0x44,0x20,0x16,
0x20,0x43,0x20,0x16,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x14,0x17,0x17,0x17,0x15,
0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,
0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x13,0x20,0x20,0x20,0x20,
0x20,0x20,0x34,0x16,0x20,0x52,0x20,0x16,0x20,0x51,0x20,0x16,0x20,0x50,0x20,0x16,
0x20,0x4F,0x20,0x16,0x20,0x4E,0x20,0x16,0x20,0x4D,0x20,0x16,0x20,0x4C,0x20,0x16,
0x20,0x4B,0x20,0x16,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x14,0x17,0x17,0x17,0x15,
0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,
0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x13,0x20,0x20,0x20,0x20,
0x20,0x20,0x35,0x16,0x20,0x5A,0x20,0x16,0x20,0x59,0x20,0x16,0x20,0x58,0x20,0x16,
0x20,0x57,0x20,0x16,0x20,0x56,0x20,0x16,0x20,0x55,0x20,0x16,0x20,0x54,0x20,0x16,
0x20,0x53,0x20,0x16,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x14,0x17,0x17,0x17,0x15,
0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,
0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x13,0x20,0x20,0x20,0x20,
0x20,0x20,0x36,0x16,0x46,0x33,0x20,0x16,0x46,0x32,0x20,0x16,0x46,0x31,0x20,0x16,
0x43,0x4F,0x44,0x16,0x43,0x41,0x50,0x16,0x47,0x52,0x41,0x16,0x43,0x54,0x52,0x16,
0x53,0x48,0x49,0x16,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x14,0x17,0x17,0x17,0x15,
0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,
0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x13,0x20,0x20,0x20,0x20,
0x20,0x20,0x37,0x16,0x52,0x45,0x54,0x16,0x53,0x45,0x4C,0x16,0x42,0x53,0x20,0x16,
0x53,0x54,0x4F,0x16,0x54,0x41,0x42,0x16,0x45,0x53,0x43,0x16,0x46,0x35,0x20,0x16,
0x46,0x34,0x20,0x16,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x14,0x17,0x17,0x17,0x15,
0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,
0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x15,0x17,0x17,0x17,0x13,0x20,0x20,0x20,0x20,
0x20,0x20,0x38,0x16,0x52,0x49,0x47,0x16,0x44,0x4F,0x57,0x16,0x55,0x50,0x20,0x16,
0x4C,0x45,0x46,0x16,0x44,0x45,0x4C,0x16,0x49,0x4E,0x53,0x16,0x48,0x4F,0x4D,0x16,
0x53,0x50,0x41,0x16,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x1A,0x17,0x17,0x17,0x11,
0x17,0x17,0x17,0x11,0x17,0x17,0x17,0x11,0x17,0x17,0x17,0x11,0x17,0x17,0x17,0x11,
0x17,0x17,0x17,0x11,0x17,0x17,0x17,0x11,0x17,0x17,0x17,0x1B,0x20,0x20,0x20,0x20};


// global variable definition --------------------------------------------------



// Functions -------------------------------------------------------------------


//
void main(void)
{
  char colorInk=0;
  char colorBG=0;
  char colorBDR=0;
  char scrcolumns=0;
  
  colorInk=PEEK(FORCLR);
  colorBG=PEEK(BAKCLR);
  colorBDR=PEEK(BDRCLR);
  scrcolumns=PEEK(LINLEN);
  
  COLOR(LIGHT_GREEN,DARK_GREEN,DARK_GREEN);    
  SCREEN(0);
    
  test();
 
  KillBuffer();


//EXIT MSXDOS ------------------------------------------------------------------
  //put the screen as it was.
  COLOR(colorInk,colorBG,colorBDR);

  if(scrcolumns<33) SCREEN(1);
  else CLS();
    
  System(_TERM0); 
//--------------------------------------------------------------------- end EXIT  

}



// call system functions 
// see MSX Assembly Page > MSX-DOS 2 function calls
// http://map.grauw.nl/resources/dos2_functioncalls.php
void System(char code)
{
code;
__asm
	push IX
	ld   IX,#0
	add  IX,SP

	ld   C,4(IX)
	call SYSTEM

	pop  IX
__endasm; 
}



/* -----------------------------------------------------------------------------

----------------------------------------------------------------------------- */
void test()
{
  char val;
  char pressKey;
  char B;
  uint i;
  uint offset;
  uint vaddr = BASE2 + (32*8);
  char isExit = 0;

  CopyToVRAM((uint) keyb_map,BASE0,0x3c0);
  
  PRINT(0,0,text01);
  PRINT(0,1,text02);
  PRINT(0,2,text03);
  
  
  // genera una copia de los caracteres en la posicion 128 en negativo
  for (i=0;i<768;i++)
  {
    val = ~ VPEEK(vaddr); //invierte el valor
    VPOKE(vaddr+768,val); //lo copia en un tile superior
    vaddr++;              // avanza a la siguiente posicion de la vram
  }

  


  while(isExit<60)  //bucle infinito
  {
    HALT;

    if (GetKeyMatrix(7)==0b11111011) isExit++;
    else isExit=0;

    for(B=0;B<9;B++)
    {
      pressKey = GetKeyMatrix(B);
      
      if (pressKey==255)
      {
        //no se han pulsado teclas de esta linea 
        offset = 244+(B*80);
        CopyToVRAM((uint) keyb_map + offset,BASE0 + offset,31);
      }else{
        if ((pressKey|0b11111110)==0b11111110) printKey(7,B);
        if ((pressKey|0b11111101)==0b11111101) printKey(6,B);
        if ((pressKey|0b11111011)==0b11111011) printKey(5,B);
        if ((pressKey|0b11110111)==0b11110111) printKey(4,B);
        if ((pressKey|0b11101111)==0b11101111) printKey(3,B);
        if ((pressKey|0b11011111)==0b11011111) printKey(2,B);
        if ((pressKey|0b10111111)==0b10111111) printKey(1,B);
        if ((pressKey|0b01111111)==0b01111111) printKey(0,B); 
      }
    
    } //END For
  } //END while
    

}



/* -----------------------------------------------------------------------------

----------------------------------------------------------------------------- */
void printKey(char column, char line)
{ 
  char tmpTile;
  uint vaddr;
  uint addr;
  
  vaddr = 244 + (column*4) +(line*80);
  addr= (uint) keyb_map + vaddr;
  
  tmpTile = peek(addr++)+96;
  VPOKE(vaddr++,tmpTile);
  tmpTile = peek(addr++)+96;
  VPOKE(vaddr++,tmpTile);
  tmpTile = peek(addr)+96;
  VPOKE(vaddr,tmpTile);
}



/* =============================================================================
 muestra un texto en la pantalla de varias lineas separadas 
 con el codigo de escape newline \n
 ejem: PRINT(0,10,"ARE YOU SURE\nYOU WANT TO\nDELETE SONG?");
============================================================================= */
void PRINT(char column, char line, char* text)
{
  char character;
  uint vaddr = GetVAddressByPosition(column, line);  

  while(*(text))
  {
    character=*(text++);
    if (character=='\n') //return
    {
      //next line
      line++;
      vaddr = GetVAddressByPosition(0, line); 
      //or  vaddr = GetVAddressByPosition(column, line); for same position
    }
    else{
      VPOKE(vaddr++,character);
    }    
  }
}


/* =============================================================================
 It provides the address of the video memory map tiles, from the screen position
 indicated.
 Proporciona la direccion de la memoria de video del mapa de tiles, a partir de
 la posicion de pantalla indicada.
 Inputs:
   column (char) 0 - 39
   line (char) 0 - 23
============================================================================= */
uint GetVAddressByPosition(char column, char line)
{
   return BASE0 + (line*40)+column; //<------ BASE0 for screen 0; use BASE5 for screen 1 
}



/* =============================================================================
 CLS
 
 Description: 
           Clear the contents of the screen.
           Fill screen map with 0x20 character.
 Input:    -        
 Output:   -
============================================================================= */
void CLS()
{
__asm

  push IX
  
  xor  A
   
  ld   IX,#BCLS
  ld   IY,(EXPTBL-1)
  call CALSLT
  ei
    
  pop  IX
  
__endasm;
}


char PEEK(uint address)
{
address;
__asm
  push IX
  ld   IX,#0
  add  IX,SP
    
  ld   L,4(IX)
  ld   H,5(IX)
  ld   L,(HL)

  pop  IX
__endasm;
}